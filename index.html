<!DOCTYPE html>
<html lang = "en">
	<head>
		<meta charset = "utf-8">
		<meta http-equiv = "X-UA-Compatible" content = "IE=edge">
		<meta name = "viewport" content = "width=device-width, initial-scale = 1">
		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
		<title>KN: Photography</title>

    		<!-- Bootstrap -->
    		<link href = "https://bootswatch.com/cyborg/bootstrap.min.css" rel = "stylesheet"> 
		<link href = "http://kevinnaquin.com/index.css" rel = "stylesheet"> 
  	</head>
  	<body align = "center">
		<div class = "container-fluid">
			<div class = "row">
				<nav class = "navbar navbar-default navbar-fixed-top transition" role = "navigation">
					<div class = "container-fluid">
						<div class = "navbar-header">
							<a class = "navbar-brand">KN</a>

							<button aria-expanded = "false" class = "navbar-toggle collapsed" data-target = "#filterMenu" data-toggle = "collapse" type = "button">
								<span class = "sr-only">Toggle navigation</span>
								<span class = "icon-bar"></span>
								<span class = "icon-bar"></span>
								<span class = "icon-bar"></span>
							</button>
						</div>

						<div class = "collapse navbar-collapse" id = "filterMenu">
							<ul class = "nav navbar-nav">
								<li><a onclick = filterImages("all")>All</a></li>
							</ul>
						</div>
					</div>
				</nav>
			</div>

			<div class = "row" id = "thumbnailContainer"></div>
			<div class = "image transition" id = "image" onclick = deselectImage() onmouseout = hideImageInfo() onmouseover = displayImageInfo()></div>
		</div>

		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src= "https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    		<script src = "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
		<script type = "text/javascript">
			var kn = {};
			var images;

			$(document).ready(function() {
				$.ajax({
					dataType: "json",
					success: function(data) {
						images = data;

						randomizeImages();

						addThumbnails();

						// load images only when they are in view
						$(window).resize(function() {deferedImageLoad(); });
						$(window).scroll(function() {
							showNavbar(); 
							deferedImageLoad(); 
						});
						deferedImageLoad();

						enableKeyboardShortcuts();
				
					},
					url: "http://kevinnaquin.com/images.json"
				});
			});

			function addThumbnails() {
				$.each(
					images,
					function(i, x) {
						var thumbnail = document.createElement("div");
						$(thumbnail).addClass("thumbnail-preview");
						$(thumbnail).addClass("transition");
						$(thumbnail).attr("id", x.hash_id);
						$(thumbnail).click(function() { selectImage(x, i); });
						$(thumbnail).css("opacity", 0);

						$("#thumbnailContainer").append(thumbnail);
					}
				);
			}

			function deferedImageLoad() {
				var windowTop = $(window).scrollTop();
				var windowBottom = windowTop + $(window).height();
				$.each(
					images,
					function(i, x) {
						var thumbnail = $("#" + x.hash_id);
						var offset = $(thumbnail).offset();
						var divTop = offset.top;
						var divBottom = divTop + $(thumbnail).height();
						
						if (!(divBottom < windowTop) && !(windowBottom < divTop)) {
							if ($(thumbnail).css("backgroundImage") == "none") { loadImage(x); }
						}
					}
				);
			}

			function deselectImage() {
				var image_full = $("#image");
				$(image_full).css("height", "");
				$(image_full).css("opacity", "");
				$(image_full).css("pointerEvents", "none");
				$(image_full).css("width", "");

				$.each(images, function(i, x) { $("#" + x.hash_id).css("opacity", ""); });
			}

			function displayImageInfo() {
				var image = kn.selectedImage;
				$("#image").html([
					"f/" + image.f_stop, 
					image.shutter_speed, 
					image.zoom + "mm", 
					"ISO" + image.iso
				].join(" "));
			}

			function enableKeyboardShortcuts() {
				$(document).on(
					"keydown",
					function(event) {
						switch (event.keyCode) {
							// left arrow key
							case 37: rewind(); break;
							// right arrow key
							case 39: fastForward(); break;	
						}
					}
				);
			}		

			function hideImageInfo() { $("#image").html(""); }

			function fastForward() {
				var index = typeof kn.selectedIndex == "undefined" ? -1 : kn.selectedIndex;
				index++;
				index = index > images.length - 1 ? 0 : index;
				selectImage(images[index], index);
			}

			function filterImages(filter) {
				if (filter == "all") { 
					$.each(images, function(i, x) { $("#" + x.hash_id).css("display", ""); }); 
				}
				else {
					$.each(
						images,
						function(i, x) {
							var thumbnail = $("#" + x.hash_id);
							if (x.filters.indexOf(filter) > -1) {$(thumbnail).css("display", "");  }
							else { $(thumbnail).css("display", "none"); }
						}
					);
				}
			}

			function loadImage(image) {
				var img = new Image();
				$(img).load(function() {
					image.height = this.height;
					if (kn.max_height < image.height || !kn.max_height) { kn.max_height = image.height; }
					image.width = this.width;
					if (kn.max_width < image.width || !kn.max_width) { kn.max_width = image.width; }

					var thumbnail = $("#" + image.hash_id);
					$(thumbnail).css("backgroundImage", "url('" + $(this).attr("src") + "')");
					$(thumbnail).css("opacity", "");
				});
				$(img).attr("src", "https://dl.dropboxusercontent.com/s/" + image.hash_id + "/" + image.name + ".JPG");
			}

			function randomizeImages() { images.sort(function() { return 0.5 - Math.random() }); }

			function rewind() {
				var index = typeof kn.selectedIndex == "undefined" ? images.length : kn.selectedIndex;
				index--;
				index = index < 0 ? images.length - 1 : index;
				selectImage(images[index], index);
			}

			function selectImage(image, index) {
				kn.selectedImage = image;
				kn.selectedIndex = index;

				var thumbnail = $("#" + image.hash_id);

				var background_image = $(thumbnail).css("backgroundImage");
				var image_full = $("#image");
				$(image_full).css("backgroundImage", background_image);
				$(image_full).css("height", image.height);
				$(image_full).css("opacity", 1);
				$(image_full).css("pointerEvents", "auto");
				$(image_full).css("width", image.width);
				if ($(image_full).html() != "") { displayImageInfo(); }


				$.each(images, function(i, x) { $("#" + x.hash_id).css("opacity", 0.1); });

				$(thumbnail).css("opacity", 0);
			}

			function showNavbar() { 
				$(".navbar").css("opacity", 1); 
				if (kn.hideNavbar) { clearTimeout(kn.hideNavbar); }
				kn.hideNavbar = setTimeout(function() { $(".navbar").css("opacity", 0); }, 5000);
			}
		</script>
  	</body>
</html>
